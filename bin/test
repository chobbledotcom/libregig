#!/usr/bin/env bash
# Run Rails tests in parallel with clean output and coverage summary
# This is the recommended way to run tests in this project

echo "ğŸš€ Running tests in parallel..."
echo "Coverage enabled, report will be in coverage/index.html"
echo ""

# Store the output to parse it
# Get the script directory to find the rails binstub
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
output=$("$SCRIPT_DIR/rails" test "$@" 2>&1)
exit_code=$?

# Display the output
echo "$output"

# Extract and highlight the final test count
if [[ "$output" =~ ([0-9]+)\ runs,\ ([0-9]+)\ assertions,\ ([0-9]+)\ failures,\ ([0-9]+)\ errors,\ ([0-9]+)\ skips ]]; then
    runs="${BASH_REMATCH[1]}"
    assertions="${BASH_REMATCH[2]}"
    failures="${BASH_REMATCH[3]}"
    errors="${BASH_REMATCH[4]}"
    skips="${BASH_REMATCH[5]}"

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    if [ "$failures" -eq 0 ] && [ "$errors" -eq 0 ]; then
        echo "âœ… All $runs tests passed! ($assertions assertions)"
    else
        total_failed=$((failures + errors))
        echo "âŒ $total_failed out of $runs tests failed!"
        [ "$failures" -gt 0 ] && echo "   Failures: $failures"
        [ "$errors" -gt 0 ] && echo "   Errors: $errors"
    fi
    [ "$skips" -gt 0 ] && echo "â¸ï¸  Skipped: $skips"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
fi

# Show coverage summary if SimpleCov ran
if [ -f "coverage/.last_run.json" ]; then
    echo ""
    echo "ğŸ“Š Coverage report: coverage/index.html"
fi

exit $exit_code
